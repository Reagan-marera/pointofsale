{% extends "layouts/base.html" %}
{% block title %}Connect Bank Account{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Connect Bank Account</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('manage_bank_accounts') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Accounts
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header text-center">
                <h4 class="mb-0">
                    <i class="bi bi-bank text-primary me-2"></i>
                    Connect Your Bank Account
                </h4>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <img src="https://cdn.plaid.com/development/plaid-logo.svg" alt="Plaid" height="40" class="mb-3">
                    <p class="lead">Securely connect your bank account using Plaid</p>
                    <p class="text-muted">
                        Your financial data is encrypted and never stored. We use bank-level security.
                    </p>
                </div>
                
                <div class="mb-4">
                    <div id="plaid-link-button"></div>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="bi bi-shield-check"></i> Security & Privacy</h6>
                    <small>
                        • Bank credentials are never stored on our servers<br>
                        • Connection uses 256-bit SSL encryption<br>
                        • Read-only access to transaction history<br>
                        • You can disconnect at any time
                    </small>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Supported Banks</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4 col-md-2 mb-3">
                        <div class="bank-logo">
                            <i class="bi bi-bank fs-1"></i>
                            <small>Equity Bank</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-2 mb-3">
                        <div class="bank-logo">
                            <i class="bi bi-bank fs-1"></i>
                            <small>KCB Bank</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-2 mb-3">
                        <div class="bank-logo">
                            <i class="bi bi-bank fs-1"></i>
                            <small>Co-operative</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-2 mb-3">
                        <div class="bank-logo">
                            <i class="bi bi-bank fs-1"></i>
                            <small>Absa Bank</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-2 mb-3">
                        <div class="bank-logo">
                            <i class="bi bi-bank fs-1"></i>
                            <small>NCBA Bank</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-2 mb-3">
                        <div class="bank-logo">
                            <i class="bi bi-bank fs-1"></i>
                            <small>Stanbic</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Plaid Link -->
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
// Wait for the DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Plaid Link
    const linkHandler = Plaid.create({
        token: '{{ link_token }}',
        onSuccess: function(public_token, metadata) {
            // Send the public_token to your server
            fetch('/api/bank/exchange_token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    public_token: public_token,
                    institution_name: metadata.institution.name,
                    institution_id: metadata.institution.institution_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Bank account connected successfully!', 'success');
                    // Redirect to transactions page
                    setTimeout(() => {
                        window.location.href = `/bank/api/transactions?connection_id=${data.connection_id}`;
                    }, 1500);
                } else {
                    showNotification(`Error: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showNotification('Network error occurred', 'danger');
            });
        },
        onLoad: function() {
            // Optional: Handle when Link loads
        },
        onExit: function(err, metadata) {
            if (err != null) {
                showNotification(`Error: ${err.display_message || err.error_message}`, 'danger');
            }
        },
        onEvent: function(eventName, metadata) {
            console.log('Event:', eventName, metadata);
        },
        env: '{{ plaid_environment }}', // 'sandbox', 'development', or 'production'
        // Additional configuration
        countryCodes: ['US', 'CA', 'GB', 'KE'],
        language: 'en',
        // Optional: Show only specific account types
        // product: ['transactions', 'auth', 'identity', 'assets'],
    });
    
    // Add connect button
    const buttonContainer = document.getElementById('plaid-link-button');
    const connectBtn = document.createElement('button');
    connectBtn.className = 'btn btn-primary btn-lg';
    connectBtn.innerHTML = '<i class="bi bi-plug me-2"></i> Connect Your Bank Account';
    connectBtn.onclick = function() {
        linkHandler.open();
    };
    buttonContainer.appendChild(connectBtn);
    
    function showNotification(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        alertDiv.style.zIndex = '1050';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }
});
</script>

<style>
.bank-logo {
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    transition: all 0.3s;
}
.bank-logo:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
    transform: translateY(-2px);
}
</style>
{% endblock %}