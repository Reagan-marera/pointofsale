{% extends "layouts/base.html" %}

{% block title %}Add Product{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Add New Product</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('products') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Products
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <form method="POST" action="{{ url_for('add_product') }}" id="product-form">
            <input type="hidden" name="redirect_url" value="{{ redirect_url }}">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Product Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Product Name *</label>
                            <select class="form-select" id="name" name="name" required>
                                <option value="" disabled>Select an item</option>
                                {% for item in items %}
                                <option value="{{ item.name }}" {% if name == item.name %}selected{% endif %}>{{ item.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="" disabled selected>Select category</option>
                                {% for category in categories %}
                                <option value="{{ category.name }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="supplier_id" class="form-label">Supplier *</label>
                            <select class="form-select" id="supplier_id" name="supplier_id" required>
                                <option value="" disabled selected>Select supplier</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="dealer_id" class="form-label">Dealer *</label>
                            <select class="form-select" id="dealer_id" name="dealer_id" required>
                                <option value="" disabled selected>Select dealer</option>
                                {% for dealer in dealers %}
                                <option value="{{ dealer.id }}">{{ dealer.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="barcode" class="form-label">Barcode *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="barcode" name="barcode" required>
                                <button class="btn btn-outline-primary" type="button" id="scan-barcode-btn" data-bs-toggle="modal" data-bs-target="#barcodeScannerModal">
                                    <i class="bi bi-upc-scan"></i> Scan
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="generate-barcode-btn">
                                    <i class="bi bi-upc"></i> Generate
                                </button>
                            </div>
                            <small class="text-muted">Scan or enter product barcode</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch pt-4">
                                <input class="form-check-input" type="checkbox" id="vatable" name="vatable">
                                <label class="form-check-label" for="vatable">VAT applicable</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Pricing & Inventory</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="buying_price" class="form-label">Buying Price (KSh) *</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="buying_price" name="buying_price" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="selling_price" class="form-label">Selling Price (KSh) *</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="selling_price" name="selling_price" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="stock" class="form-label">Initial Stock *</label>
                            <input type="number" class="form-control" id="stock" name="stock" value="0" min="0" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="min_stock" class="form-label">Minimum Stock Level *</label>
                            <input type="number" class="form-control" id="min_stock" name="min_stock" value="5" min="0" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="reset" class="btn btn-secondary me-md-2">Reset</button>
                <button type="submit" class="btn btn-primary">Save Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="modal fade" id="barcodeScannerModal" tabindex="-1" aria-labelledby="barcodeScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="barcodeScannerModalLabel">Barcode Scanner</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Point the camera at the barcode to scan
                </div>

                <div id="scanner-container" class="text-center">
                    <div id="interactive" class="viewport mb-3"></div>
                    <div class="scanner-overlay">
                        <div class="scanner-line"></div>
                    </div>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="manual-barcode-input" placeholder="Or enter barcode manually">
                        <button class="btn btn-primary" type="button" id="manual-scan-confirm-btn">
                            <i class="bi bi-check-circle"></i> Confirm
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Tom Select CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css"/>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<!-- Quagga for barcode scanning -->
<script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Tom Select for searchable dropdowns
    new TomSelect("#name", {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
    new TomSelect("#category", {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
    new TomSelect("#supplier_id", {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
    new TomSelect("#dealer_id", {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });

    // Barcode Scanner Logic
    const barcodeScannerModal = new bootstrap.Modal(document.getElementById('barcodeScannerModal'));
    let scannerActive = false;
    let scannerInitialized = false;
    let lastScannedCode = null;
    let scanTimeout = null;

    // Initialize scanner when modal is shown
    document.getElementById('barcodeScannerModal').addEventListener('shown.bs.modal', function() {
        if (!scannerInitialized) {
            initBarcodeScanner();
            scannerInitialized = true;
        } else {
            startScanner();
        }
        document.getElementById('manual-barcode-input').value = '';
        lastScannedCode = null;
    });

    // Clean up scanner when modal is hidden
    document.getElementById('barcodeScannerModal').addEventListener('hidden.bs.modal', function() {
        stopScanner();
        clearTimeout(scanTimeout);
    });

    // Scan button click handler
    document.getElementById('scan-barcode-btn').addEventListener('click', function() {
        barcodeScannerModal.show();
    });

    // Manual barcode confirmation
    document.getElementById('manual-scan-confirm-btn').addEventListener('click', function() {
        const barcode = document.getElementById('manual-barcode-input').value.trim();
        if (barcode) {
            processScannedBarcode(barcode);
            barcodeScannerModal.hide();
        } else {
            alert('Please enter a barcode');
        }
    });

    // Generate barcode button
    document.getElementById('generate-barcode-btn').addEventListener('click', function() {
        const randomBarcode = Math.floor(100000000000 + Math.random() * 900000000000).toString();
        document.getElementById('barcode').value = randomBarcode;
    });

    function initBarcodeScanner() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    width: 640,
                    height: 480,
                    facingMode: "environment"
                },
            },
            decoder: {
                readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader"],
                multiple: false
            },
            locate: true,
            debug: {
                drawBoundingBox: true,
                showFrequency: true,
                drawScanline: true,
                showPattern: true
            }
        }, function(err) {
            if (err) {
                console.error("Scanner initialization error:", err);
                alert("Failed to initialize barcode scanner. Please use manual entry.");
                return;
            }
            console.log("Scanner initialized successfully");
            startScanner();
        });

        Quagga.onProcessed(function(result) {
            const drawingCtx = Quagga.canvas.ctx.overlay;
            const drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0,
                        parseInt(drawingCanvas.getAttribute("width")),
                        parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(function(box) {
                        return box !== result.box;
                    }).forEach(function(box) {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                }

                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                }
            }
        });

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            console.log("Barcode detected:", code);

            // Prevent duplicate scans of the same code
            if (code === lastScannedCode) {
                return;
            }

            lastScannedCode = code;
            processScannedBarcode(code);

            // Add slight delay before closing to give user feedback
            scanTimeout = setTimeout(() => {
                stopScanner();
                barcodeScannerModal.hide();
            }, 500);
        });
    }

    function processScannedBarcode(barcode) {
        document.getElementById('barcode').value = barcode;
        document.getElementById('manual-barcode-input').value = barcode;
        document.getElementById('name').focus();
    }

    function startScanner() {
        if (!scannerActive && scannerInitialized) {
            Quagga.start();
            scannerActive = true;
            console.log("Scanner started");
        }
    }

    function stopScanner() {
        if (scannerActive) {
            Quagga.stop();
            scannerActive = false;
            console.log("Scanner stopped");
        }
    }

    // Form validation
    document.getElementById('product-form').addEventListener('submit', function(e) {
        // Validate selling price is higher than buying price
        const buyingPrice = parseFloat(document.getElementById('buying_price').value);
        const sellingPrice = parseFloat(document.getElementById('selling_price').value);

        if (sellingPrice <= buyingPrice) {
            e.preventDefault();
            alert('Selling price must be higher than buying price');
            document.getElementById('selling_price').focus();
        }

        // Validate barcode is unique (you would typically do this server-side)
        const barcode = document.getElementById('barcode').value.trim();
        if (barcode.length < 8) {
            e.preventDefault();
            alert('Barcode must be at least 8 characters long');
            document.getElementById('barcode').focus();
        }
    });
});
</script>

<style>
.viewport {
    position: relative;
    width: 100%;
    height: 300px;
    overflow: hidden;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.viewport canvas, .viewport video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#scanner-container {
    position: relative;
}

.scanner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
}

.scanner-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background-color: rgba(255, 0, 0, 0.5);
    box-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
    animation: scan 2s infinite linear;
}

@keyframes scan {
    0% { top: 0; }
    100% { top: 100%; }
}

/* Debug canvas styling */
canvas.drawing, canvas.drawingBuffer {
    position: absolute;
    left: 0;
    top: 0;
}
</style>
{% endblock %}
