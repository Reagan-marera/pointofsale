{% extends "layouts/base.html" %}
{% block title %}Add Payment Gateway{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Add Payment Gateway</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('manage_payment_gateways') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Gateways
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Gateway Configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_payment_gateway') }}">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Gateway Name *</label>
                            <select class="form-select" id="name" name="name" required onchange="showGatewayHelp(this.value)">
                                <option value="">Select Gateway</option>
                                <option value="stripe">Stripe</option>
                                <option value="paypal">PayPal</option>
                                <option value="mpesa">M-Pesa</option>
                                <option value="equity">Equity Bank</option>
                                <option value="kcb">KCB Bank</option>
                                <option value="coop">Co-operative Bank</option>
                                <option value="custom">Custom Gateway</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="gateway_type" class="form-label">Gateway Type *</label>
                            <select class="form-select" id="gateway_type" name="gateway_type" required>
                                <option value="">Select Type</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="wallet">Digital Wallet</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="api_key" class="form-label">API Key *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="api_key" name="api_key" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('api_key')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">Live API key from gateway provider</small>
                        </div>
                        <div class="col-md-6">
                            <label for="api_secret" class="form-label">API Secret *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="api_secret" name="api_secret" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('api_secret')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">Live API secret key</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="webhook_secret" class="form-label">Webhook Secret</label>
                            <input type="password" class="form-control" id="webhook_secret" name="webhook_secret">
                            <small class="form-text text-muted">For receiving payment notifications</small>
                        </div>
                        <div class="col-md-6">
                            <label for="merchant_id" class="form-label">Merchant ID</label>
                            <input type="text" class="form-control" id="merchant_id" name="merchant_id">
                            <small class="form-text text-muted">Your merchant ID with the gateway</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                <label class="form-check-label" for="is_active">
                                    Activate Gateway
                                </label>
                                <small class="form-text text-muted d-block">
                                    Gateway will be available for payments
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="test_mode" name="test_mode" checked>
                                <label class="form-check-label" for="test_mode">
                                    Test Mode
                                </label>
                                <small class="form-text text-muted d-block">
                                    Use sandbox/test environment first
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="reset" class="btn btn-secondary">Clear</button>
                        <button type="submit" class="btn btn-primary">Save Gateway</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0" id="gatewayHelpTitle">Gateway Information</h6>
            </div>
            <div class="card-body" id="gatewayHelpContent">
                <p class="text-muted">Select a gateway to see setup instructions</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Security Guidelines</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h6><i class="bi bi-shield-check"></i> Important</h6>
                    <small>
                        • Never share API keys publicly<br>
                        • Use environment variables in production<br>
                        • Rotate keys periodically<br>
                        • Enable webhook verification<br>
                        • Test in sandbox first
                    </small>
                </div>
                
                <div class="alert alert-info">
                    <h6><i class="bi bi-lightning"></i> Quick Test</h6>
                    <small>
                        After saving, test the connection with a small transaction.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showGatewayHelp(gateway) {
    const helpContent = document.getElementById('gatewayHelpContent');
    const helpTitle = document.getElementById('gatewayHelpTitle');
    
    let content = '';
    let title = 'Gateway Information';
    
    switch(gateway) {
        case 'stripe':
            title = 'Stripe Setup';
            content = `
                <h6><i class="bi bi-stripe text-primary"></i> Stripe Configuration</h6>
                <ol class="small">
                    <li>Go to <a href="https://dashboard.stripe.com" target="_blank">Stripe Dashboard</a></li>
                    <li>Navigate to Developers → API Keys</li>
                    <li>Copy your Publishable Key and Secret Key</li>
                    <li>Set up webhook endpoint: <code>${window.location.origin}/payment/webhook/stripe</code></li>
                    <li>Copy webhook signing secret</li>
                </ol>
                <div class="alert alert-info small">
                    <strong>Test Mode:</strong> Use keys prefixed with <code>sk_test_</code> or <code>pk_test_</code>
                </div>
            `;
            break;
            
        case 'paypal':
            title = 'PayPal Setup';
            content = `
                <h6><i class="bi bi-paypal text-info"></i> PayPal Configuration</h6>
                <ol class="small">
                    <li>Go to <a href="https://developer.paypal.com" target="_blank">PayPal Developer</a></li>
                    <li>Create a REST API app</li>
                    <li>Copy Client ID and Secret</li>
                    <li>Set Return URL: <code>${window.location.origin}/payment/paypal/return</code></li>
                    <li>Set Cancel URL: <code>${window.location.origin}/payment/paypal/cancel</code></li>
                </ol>
                <div class="alert alert-info small">
                    <strong>Note:</strong> Use sandbox credentials for testing
                </div>
            `;
            break;
            
        case 'mpesa':
            title = 'M-Pesa Setup';
            content = `
                <h6><i class="bi bi-phone text-success"></i> M-Pesa Configuration</h6>
                <ol class="small">
                    <li>Contact Safaricom Developer Portal</li>
                    <li>Register for Daraja API</li>
                    <li>Get Consumer Key and Secret</li>
                    <li>Configure Callback URLs</li>
                    <li>Test with Safaricom sandbox</li>
                </ol>
                <div class="alert alert-info small">
                    <strong>Requirements:</strong> Business registration with Safaricom
                </div>
            `;
            break;
            
        case 'equity':
            title = 'Equity Bank Setup';
            content = `
                <h6><i class="bi bi-bank text-primary"></i> Equity Bank EazzyPay</h6>
                <ol class="small">
                    <li>Contact Equity Bank Business Banking</li>
                    <li>Request EazzyPay API integration</li>
                    <li>Get Merchant ID and API credentials</li>
                    <li>Configure IP whitelisting</li>
                </ol>
            `;
            break;
            
        default:
            content = '<p class="text-muted">Select a gateway to see setup instructions</p>';
    }
    
    helpTitle.textContent = title;
    helpContent.innerHTML = content;
}

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        button.className = 'bi bi-eye-slash';
    } else {
        field.type = 'password';
        button.className = 'bi bi-eye';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const gatewaySelect = document.getElementById('name');
    if (gatewaySelect.value) {
        showGatewayHelp(gatewaySelect.value);
    }
});
</script>

<style>
.form-check-label {
    font-weight: 500;
}
.alert h6 {
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}