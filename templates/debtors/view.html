{% extends "layouts/base.html" %}
{% block title %}Debtor Details - {{ debtor.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-person"></i> {{ debtor.name }}</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('manage_debtors') }}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
            <button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#addDebtModal">
                <i class="bi bi-cart-plus"></i> Record New Debt
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#paymentModal">
                <i class="bi bi-cash-stack"></i> Record Payment
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 opacity-75">Total Balance Owing</h6>
                    <h2 class="card-title display-5 fw-bold">KES {{ "%.2f"|format(debtor.total_debt) }}</h2>
                    <hr class="opacity-25">
                    <p class="mb-0 small"><i class="bi bi-info-circle"></i> Payments made are automatically deducted from the oldest debts.</p>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Contact Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <p class="mb-1 text-muted">Phone</p>
                            <p class="fw-bold">{{ debtor.phone or 'Not provided' }}</p>
                        </div>
                        <div class="col-sm-4">
                            <p class="mb-1 text-muted">Email</p>
                            <p class="fw-bold">{{ debtor.email or 'Not provided' }}</p>
                        </div>
                        <div class="col-sm-4">
                            <p class="mb-1 text-muted">Created On</p>
                            <p class="fw-bold">{{ debtor.created_at.strftime('%Y-%m-%d') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="debtorTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="debts-tab" data-bs-toggle="tab" data-bs-target="#debts" type="button" role="tab">Debt History</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">Payment History</button>
        </li>
    </ul>

    <div class="tab-content" id="debtorTabContent">
        <div class="tab-pane fade show active" id="debts" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Items Taken</th>
                                    <th class="text-end">Total (KES)</th>
                                    <th class="text-end">Balance (KES)</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for debt in debtor.debts|sort(attribute='date', reverse=True) %}
                                <tr>
                                    <td>{{ debt.date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <ul class="list-unstyled mb-0 small">
                                        {% for item in debt.items %}
                                            <li>{{ item.quantity }}x {{ item.product.name }} @ {{ item.unit_price }}</li>
                                        {% endfor %}
                                        </ul>
                                    </td>
                                    <td class="text-end">{{ "%.2f"|format(debt.total_amount) }}</td>
                                    <td class="text-end fw-bold">{{ "%.2f"|format(debt.remaining_amount) }}</td>
                                    <td class="text-center">
                                        {% if debt.status == 'paid' %}
                                        <span class="badge bg-success">Paid</span>
                                        {% elif debt.status == 'partial' %}
                                        <span class="badge bg-info">Partial</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="5" class="text-center text-muted">No debt history.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="payments" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Method</th>
                                    <th>Reference</th>
                                    <th class="text-end">Amount (KES)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in debtor.payments|sort(attribute='payment_date', reverse=True) %}
                                <tr>
                                    <td>{{ payment.payment_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td><span class="badge bg-light text-dark border">{{ payment.payment_method|capitalize }}</span></td>
                                    <td><code>{{ payment.reference or '-' }}</code></td>
                                    <td class="text-end text-success fw-bold">+ {{ "%.2f"|format(payment.amount) }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center text-muted">No payment history.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Debt Modal -->
<div class="modal fade modal-lg" id="addDebtModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Items Taken by {{ debtor.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7 border-end">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="productSearch" placeholder="Search product name or barcode...">
                            <button class="btn btn-outline-primary" type="button" onclick="searchProducts()">Search</button>
                        </div>
                        <div id="searchResults" class="list-group list-group-flush mb-3" style="max-height: 250px; overflow-y: auto;">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                    <div class="col-md-5">
                        <h6>Items List</h6>
                        <div id="selectedItems" class="mb-3" style="min-height: 100px;">
                            <p class="text-muted small">No items added yet.</p>
                        </div>
                        <div class="d-flex justify-content-between border-top pt-2">
                            <span class="fw-bold">Total:</span>
                            <span class="fw-bold text-primary" id="totalDebtAmount">KES 0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitDebt()">Record Debt</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Payment from {{ debtor.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Amount Paid (KES)</label>
                    <input type="number" class="form-control form-control-lg" id="paymentAmount" step="0.01" max="{{ debtor.total_debt }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod">
                        <option value="cash">Cash</option>
                        <option value="mpesa">M-Pesa</option>
                        <option value="bank_transfer">Bank Transfer</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Reference (Optional)</label>
                    <input type="text" class="form-control" id="paymentRef" placeholder="M-Pesa Ref or Bank Ref">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitPayment()">Save Payment</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let debtCart = [];

function searchProducts() {
    const query = document.getElementById('productSearch').value;
    if (query.length < 2) return;

    fetch(`/api/products/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(products => {
            const results = document.getElementById('searchResults');
            results.innerHTML = '';
            products.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                btn.innerHTML = `
                    <div>
                        <div class="fw-bold">${p.name}</div>
                        <small class="text-muted">Stock: ${p.stock} | Barcode: ${p.barcode}</small>
                    </div>
                    <span class="badge bg-primary rounded-pill">KES ${p.price}</span>
                `;
                btn.onclick = () => addToCart(p);
                results.appendChild(btn);
            });
        });
}

function addToCart(p) {
    const existing = debtCart.find(item => item.id === p.id);
    if (existing) {
        existing.quantity += 1;
    } else {
        debtCart.push({...p, quantity: 1});
    }
    renderCart();
}

function removeFromCart(id) {
    debtCart = debtCart.filter(item => item.id !== id);
    renderCart();
}

function renderCart() {
    const list = document.getElementById('selectedItems');
    let total = 0;

    if (debtCart.length === 0) {
        list.innerHTML = '<p class="text-muted small">No items added yet.</p>';
        document.getElementById('totalDebtAmount').innerText = 'KES 0.00';
        return;
    }

    list.innerHTML = '';
    debtCart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded';
        div.innerHTML = `
            <div>
                <div class="fw-bold small">${item.name}</div>
                <small>${item.quantity} x ${item.price}</small>
            </div>
            <div class="d-flex align-items-center">
                <span class="me-2 fw-bold">KES ${itemTotal.toFixed(2)}</span>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="removeFromCart(${item.id})">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
        `;
        list.appendChild(div);
    });

    document.getElementById('totalDebtAmount').innerText = `KES ${total.toFixed(2)}`;
}

function submitDebt() {
    if (debtCart.length === 0) return alert('Add some items first');

    fetch('/api/debtors/add_debt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            debtor_id: {{ debtor.id }},
            items: debtCart
        })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function submitPayment() {
    const amount = document.getElementById('paymentAmount').value;
    if (!amount || amount <= 0) return alert('Enter a valid amount');

    fetch('/api/debtors/payment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            debtor_id: {{ debtor.id }},
            amount: amount,
            payment_method: document.getElementById('paymentMethod').value,
            reference: document.getElementById('paymentRef').value
        })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}
</script>
{% endblock %}
